name: Deploy Workspace

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Pull latest code
        run: |
          cd /mnt/d/Docker/namgun-workspace
          git fetch origin main
          git reset --hard origin/main

      - name: Ensure storage volume
        run: |
          cd /mnt/d/Docker/namgun-workspace
          . .env 2>/dev/null || true
          VOL="${STORAGE_VOLUME:-ws-storage-data}"
          docker volume inspect "$VOL" >/dev/null 2>&1 || docker volume create "$VOL"

      - name: Build and deploy
        run: |
          cd /mnt/d/Docker/namgun-workspace
          docker compose up -d --build

      - name: Health check
        run: |
          echo "Waiting for services to start..."
          for i in $(seq 1 10); do
            if curl -sf --max-time 5 http://localhost:8000/api/health; then
              echo ""
              echo "Deploy successful (attempt $i)"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "Health check failed after 10 attempts"
          exit 1
